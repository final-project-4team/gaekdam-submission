<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gaekdam.gaekdambe.customer_service.loyalty.query.mapper.LoyaltyHistoryMapper">

    <select id="findHistory"
            resultType="com.gaekdam.gaekdambe.customer_service.loyalty.query.dto.response.LoyaltyHistoryResponse">
        SELECT
        lh.changed_at AS changedAt,

        CASE
        WHEN lh.before_loyalty_grade_code IS NULL THEN '가입'
        WHEN lh.before_loyalty_grade_code != lh.after_loyalty_grade_code THEN '등급 변경'
        ELSE '변경'
        END AS changeType,

        CASE
        WHEN lh.before_loyalty_grade_code IS NULL
        THEN COALESCE(ag.loyalty_grade_name, CONCAT('#', lh.after_loyalty_grade_code))
        ELSE CONCAT(
        COALESCE(bg.loyalty_grade_name, CONCAT('#', lh.before_loyalty_grade_code)),
        ' => ',
        COALESCE(ag.loyalty_grade_name, CONCAT('#', lh.after_loyalty_grade_code))
        )
        END AS content,

        lh.change_source AS changeSource,

        CASE
        WHEN lh.change_source = 'SYSTEM' THEN NULL
        ELSE lh.employee_code
        END AS changedByEmployeeCode

        FROM loyalty_history lh
        JOIN loyalty l
        ON l.loyalty_code = lh.loyalty_code
        AND l.hotel_group_code = #{hotelGroupCode}
        AND l.customer_code = #{customerCode}

        LEFT JOIN loyalty_grade bg
        ON bg.loyalty_grade_code = lh.before_loyalty_grade_code
        AND bg.hotel_group_code = l.hotel_group_code

        LEFT JOIN loyalty_grade ag
        ON ag.loyalty_grade_code = lh.after_loyalty_grade_code
        AND ag.hotel_group_code = l.hotel_group_code

        WHERE lh.changed_at <![CDATA[ >= ]]> #{from}
        AND lh.changed_at <![CDATA[ <= ]]> #{to}

        ORDER BY lh.changed_at DESC
        LIMIT #{page.size} OFFSET #{page.offset}
    </select>

    <select id="countHistory" resultType="long">
        SELECT COUNT(1)
        FROM loyalty_history lh
        JOIN loyalty l
        ON l.loyalty_code = lh.loyalty_code
        AND l.hotel_group_code = #{hotelGroupCode}
        AND l.customer_code = #{customerCode}
        WHERE lh.changed_at <![CDATA[ >= ]]> #{from}
        AND lh.changed_at <![CDATA[ <= ]]> #{to}
    </select>

</mapper>
