<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gaekdam.gaekdambe.reservation_service.reservation.query.mapper.ReservationMapper">

    <!-- =========================
         예약 목록 조회
         ========================= -->
    <select id="findReservations"
            resultType="com.gaekdam.gaekdambe.reservation_service.reservation.query.dto.response.ReservationResponse">

        SELECT
        r.reservation_code AS reservationCode,
        r.reservation_status AS reservationStatus,
        r.checkin_date AS checkinDate,
        r.checkout_date AS checkoutDate,
        r.guest_count AS guestCount,
        r.guest_type AS guestType,
        r.reservation_channel AS reservationChannel,
        r.reservation_room_price AS reservationRoomPrice,
        r.reservation_package_price AS reservationPackagePrice,
        r.total_price AS totalPrice,
        r.reserved_at AS reservedAt,
        r.created_at AS createdAt,
        r.property_code AS propertyCode,
        r.room_code AS roomCode,
        r.customer_code AS customerCode,
        r.package_code AS packageCode
        FROM reservation r
        JOIN property p ON r.property_code = p.property_code

        <where>
            <!-- SaaS 호텔 스코프 -->
            AND p.hotel_group_code = #{search.hotelGroupCode}

            <if test="search.status != null">
                AND r.reservation_status = #{search.status}
            </if>

            <if test="search.reservationChannel != null">
                AND r.reservation_channel = #{search.reservationChannel}
            </if>

            <if test="search.guestType != null">
                AND r.guest_type = #{search.guestType}
            </if>

            <if test="search.propertyCode != null">
                AND r.property_code = #{search.propertyCode}
            </if>

            <if test="search.roomCode != null">
                AND r.room_code = #{search.roomCode}
            </if>

            <if test="search.customerCode != null">
                AND r.customer_code = #{search.customerCode}
            </if>

            <if test="search.hasPackage != null">
                <if test="search.hasPackage">
                    AND r.package_code IS NOT NULL
                </if>
                <if test="!search.hasPackage">
                    AND r.package_code IS NULL
                </if>
            </if>

            <if test="search.fromDate != null">
                AND r.checkin_date <![CDATA[ >= ]]> #{search.fromDate}
            </if>

            <if test="search.toDate != null">
                AND r.checkout_date <![CDATA[ <= ]]> #{search.toDate}
            </if>
        </where>

        ORDER BY ${sort.sortBy} ${sort.direction}
        LIMIT #{page.size} OFFSET #{page.offset}
    </select>

    <!-- =========================
         예약 총 개수
         ========================= -->
    <select id="countReservations" resultType="long">

        SELECT COUNT(*)
        FROM reservation r
        JOIN property p ON r.property_code = p.property_code

        <where>
            <!-- SaaS 호텔 스코프 -->
            AND p.hotel_group_code = #{search.hotelGroupCode}

            <if test="search.status != null">
                AND r.reservation_status = #{search.status}
            </if>

            <if test="search.reservationChannel != null">
                AND r.reservation_channel = #{search.reservationChannel}
            </if>

            <if test="search.guestType != null">
                AND r.guest_type = #{search.guestType}
            </if>

            <if test="search.propertyCode != null">
                AND r.property_code = #{search.propertyCode}
            </if>

            <if test="search.roomCode != null">
                AND r.room_code = #{search.roomCode}
            </if>

            <if test="search.customerCode != null">
                AND r.customer_code = #{search.customerCode}
            </if>

            <if test="search.hasPackage != null">
                <if test="search.hasPackage">
                    AND r.package_code IS NOT NULL
                </if>
                <if test="!search.hasPackage">
                    AND r.package_code IS NULL
                </if>
            </if>

            <if test="search.fromDate != null">
                AND r.checkin_date <![CDATA[ >= ]]> #{search.fromDate}
            </if>

            <if test="search.toDate != null">
                AND r.checkout_date <![CDATA[ <= ]]> #{search.toDate}
            </if>
        </where>
    </select>

</mapper>
